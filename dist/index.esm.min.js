import{BasePlugin as e}from"amis-editor-core";export{BasePlugin,getSchemaTpl}from"amis-editor-core";import t from"react";import"jquery";import{createApp as o,isProxy as r,shallowRef as n,ref as s}from"vue";function i(e,t,o=!0){const r=function(e,t=!0){const o=e&&e.__super?Object.create(e.__super,{__super:{value:e.__super,writable:!1,enumerable:!1}}):Object.create(Object.prototype);return t&&e&&Object.keys(e).forEach((t=>o[t]=e[t])),o}(e,o);return t&&Object.keys(t).forEach((e=>r[e]=t[e])),r}const a="[amis-widget]";var c,u;function m(t,o){const r=o?.rendererName||o?.type;if(t&&t.prototype instanceof e)return p(t,r),t;class n extends e{constructor(e){super(e)}}return Object.assign(n.prototype,new t),o&&Object.assign(n.prototype,o),p(n,r),n}function p(e,t){if(e&&function(e){let t=!1;if(!e)return!1;const o=new e;return o.rendererName?o.name?o.description?!o.tags||Array.isArray(o.tags)&&0===o.tags.length?console.error(`${a}自定义插件注册失败，自定义组件分类（tags）不能为空。`):o.panelTitle?(o.icon||Object.assign(e.prototype,{icon:"fa fa-file-code-o"}),t=!0):console.error(`${a}自定义插件注册失败，自定义组件配置面板Title（panelTitle）不能为空。`):console.error(`${a}自定义插件注册失败，自定义组件描述（description）不能为空。`):console.error(`${a}自定义插件注册失败，自定义组件名称（name）不能为空。`):console.error(`${a}自定义插件注册失败，关联渲染器（rendererName）不能为空。`),t}(e)){const o=t||(new e).rendererName;if(Object.assign(e.prototype,{isNpmCustomWidget:!0,name:o}),window&&window.postMessage){(function(e,t){window&&!window.AMISEditorCustomPlugins&&(window.AMISEditorCustomPlugins={});if(!window.AMISEditorCustomPlugins[e])return window.AMISEditorCustomPlugins[e]=t,e;console.error(`${a}注册自定义插件失败，已存在重名插件(${e})。`);return null})(o,e)&&(console.info(`${a}触发注册自定义插件(${o})事件`),window.postMessage({type:"amis-widget-register-event",eventMsg:`${a}注册一个自定义amis-editor插件`,editorPluginName:o},"*"))}}}function f(e){if(e&&("function"==typeof e||"object"==typeof e)){class o extends t.Component{dom;instance;constructor(t){super(t),this.domRef=this.domRef.bind(this),this.instance="function"==typeof e?new e:e}componentDidMount(){const{onMount:e}=this.instance;e&&e.apply(this.instance,[this.props])}componentDidUpdate(e){const{onUpdate:t}=this.instance;t&&t.apply(this.instance,[this.props,e])}componentWillUnmount(){const{onUnmout:e}=this.instance;e&&e.apply(this.instance,this.props)}domRef(e){this.instance.$root=this.dom=e,this._render()}_render(){if(!this.dom)return;let e=this.instance.template;"string"==typeof e?this.dom.innerHTML=e:"function"==typeof e&&(this.dom.innerHTML=e(this.props))}render(){return t.createElement("div",{ref:this.domRef})}}return o}}function d(e){if(e&&("function"==typeof e||"object"==typeof e)){class a extends t.Component{domRef;app;vm;isUnmount;constructor(e){super(e),this.domRef=t.createRef(),this.resolveAmisProps=this.resolveAmisProps.bind(this)}componentDidMount(){const{amisData:t,amisFunc:r}=this.resolveAmisProps(),{data:n,...s}=e="function"==typeof e?new e:e;this.app=o({data:()=>i(t,"function"==typeof n?n():n),...s,props:i(r,s.props||{})}),this.vm=this.app.mount(this.domRef.current)}componentDidUpdate(){if(!this.isUnmount){const{amisData:e}=this.resolveAmisProps();this.vm&&Object.keys(e).forEach((t=>{this.vm[t]=e[t]}))}}componentWillUnmount(){this.isUnmount=!0,this.app.unmount()}resolveAmisProps(){let e={},t={};return Object.keys(this.props).forEach((o=>{const i=this.props[o];var a;"function"==typeof i?e[o]=i:r(i)?t[o]=n(i):(a=i,"Object"===Object.prototype.toString.call(a).slice(8,-1)?t[o]=s(i):t[o]=i)})),{amisData:t,amisFunc:e}}render(){return t.createElement("div",{ref:this.domRef})}}return a}}function l(e,t){if(!e)return;const o={type:"",usage:c.renderer,weight:0,framework:u.react};var r;if(t&&(r=t,"String"===Object.prototype.toString.call(r).slice(8,-1))?Object.assign(o,{type:t}):Object.assign(o,t),o&&!o.type)console.error(`${a}amis渲染器注册失败，渲染器类型（type）不能为空。`);else{o.framework=function(e){let t=u.react;if(!e)return t;let o=e.toLowerCase().trim();switch(o){case"jquery":case"jq":o=u.jquery;break;case"vue2":case"vue 2":case"vue2.0":case"vue 2.0":o=u.vue2,console.error("vue3-amis-widget不支持vue2.0技术栈，请改用amis-widget支持。");break;case"vue":case"vue3":case"vue 3":case"vue3.0":case"vue 3.0":o=u.vue3;break;default:o=u.react}return o}(o.framework),o.usage=function(e){let t=c.renderer;if(!e)return t;let o=e.toLowerCase().trim();switch(o){case"renderer":case"renderers":default:o=c.renderer;break;case"formitem":case"form-item":case"form item":o=c.formitem;break;case"options":case"option":case"formoption":case"form-option":case"form option":o=c.options}return o}(o.usage);const t={renderer:()=>{},formitem:()=>{},options:()=>{}},r={react:e=>e,vue2:d,vue3:d,jquery:f}[o.framework](e);if(t[o.usage]){if(window&&window.postMessage){const e=function(e,t){window&&!window.AmisCustomRenderers&&(window.AmisCustomRenderers={});if(!window.AmisCustomRenderers[e])return window.AmisCustomRenderers[e]=t,e;console.error(`${a}注册amis渲染器失败，已存在重名渲染器(${e})。`);return null}(o.type,{type:o.type,weight:o.weight,usage:o.usage,framework:o.framework,component:r});e&&(console.info(`${a}触发注册amis渲染器(${e})事件`),window.postMessage({type:"amis-renderer-register-event",eventMsg:`${a}注册一个自定义amis渲染器`,amisRenderer:{type:e,weight:o.weight,usage:o.usage}},"*"))}}else console.error(`${a}amis渲染器注册失败，暂不支持${o.usage}组件类型。`)}}!function(e){e.renderer="renderer",e.formitem="formitem",e.options="options"}(c||(c={})),function(e){e.react="react",e.vue2="vue2",e.vue3="vue3",e.jquery="jquery"}(u||(u={}));export{d as createVue3Component,m as registerAmisEditorPlugin,l as registerRendererByType};
