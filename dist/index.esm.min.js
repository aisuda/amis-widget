import{BasePlugin as e}from"amis-editor-core";export{BasePlugin,getSchemaTpl}from"amis-editor-core";import t from"react";import"jquery";import{ScopedContext as o}from"amis-core";import{createApp as n,isProxy as r,shallowRef as s,ref as i}from"vue";function a(e,t,o=!0){const n=function(e,t=!0){const o=e&&e.__super?Object.create(e.__super,{__super:{value:e.__super,writable:!1,enumerable:!1}}):Object.create(Object.prototype);return t&&e&&Object.keys(e).forEach((t=>o[t]=e[t])),o}(e,o);return t&&Object.keys(t).forEach((e=>n[e]=t[e])),n}const c="[amis-widget]";var m,p;function u(t,o){const n=o?.rendererName||o?.type;if(t&&t.prototype instanceof e)return d(t,n),t;class r extends e{constructor(e){super(e)}}return Object.assign(r.prototype,new t),o&&Object.assign(r.prototype,o),d(r,n),r}function d(e,t){if(e&&function(e){let t=!1;if(!e)return!1;const o=new e;return o.rendererName?o.name?o.description?!o.tags||Array.isArray(o.tags)&&0===o.tags.length?console.error(`${c}自定义插件注册失败，自定义组件分类（tags）不能为空。`):o.panelTitle?(o.icon||Object.assign(e.prototype,{icon:"fa fa-file-code-o"}),t=!0):console.error(`${c}自定义插件注册失败，自定义组件配置面板Title（panelTitle）不能为空。`):console.error(`${c}自定义插件注册失败，自定义组件描述（description）不能为空。`):console.error(`${c}自定义插件注册失败，自定义组件名称（name）不能为空。`):console.error(`${c}自定义插件注册失败，关联渲染器（rendererName）不能为空。`),t}(e)){const o=t||(new e).rendererName;if(Object.assign(e.prototype,{isNpmCustomWidget:!0,rendererName:o}),window&&window.postMessage){(function(e,t){window&&!window.AMISEditorCustomPlugins&&(window.AMISEditorCustomPlugins={});if(!window.AMISEditorCustomPlugins[e])return window.AMISEditorCustomPlugins[e]=t,e;console.error(`${c}注册自定义插件失败，已存在重名插件(${e})。`);return null})(o,e)&&(console.info(`${c}触发注册自定义插件(${o})事件`),window.postMessage({type:"amis-widget-register-event",eventMsg:`${c}注册一个自定义amis-editor插件`,editorPluginName:o},"*"))}}}function f(e){if(e&&("function"==typeof e||"object"==typeof e)){class n extends t.Component{dom;instance;static contextType=o;constructor(t,o){super(t),this.domRef=this.domRef.bind(this);o.registerComponent(this),this.instance="function"==typeof e?new e:e}componentDidMount(){const{onMount:e}=this.instance;e&&e.apply(this.instance,[this.props])}componentDidUpdate(e){const{onUpdate:t}=this.instance;t&&t.apply(this.instance,[this.props,e])}componentWillUnmount(){this.context.unRegisterComponent(this);const{onUnmout:e}=this.instance;e&&e.apply(this.instance,this.props)}domRef(e){this.instance.$root=this.dom=e,this._render()}_render(){if(!this.dom)return;let e=this.instance.template;"string"==typeof e?this.dom.innerHTML=e:"function"==typeof e&&(this.dom.innerHTML=e(this.props))}reload(){this.instance&&this.instance.reload?this.instance.reload():console.warn("自定义组件中暂不支持reload动作。")}doAction(e,t){this.instance&&this.instance.doAction?this.instance.doAction(e,t):console.warn("自定义组件中不存在doAction。")}render(){return t.createElement("div",{ref:this.domRef})}}return n}}function l(e){if(e&&("function"==typeof e||"object"==typeof e)){class c extends t.Component{domRef;app;vm;isUnmount;static contextType=o;constructor(e,o){super(e),this.domRef=t.createRef();o.registerComponent(this),this.resolveAmisProps=this.resolveAmisProps.bind(this)}componentDidMount(){const{amisData:t,amisFunc:o}=this.resolveAmisProps(),{data:r,...s}=e="function"==typeof e?new e:e,i=a("function"==typeof r?r():r,t);this.app=n({data:()=>i,...s,props:a(o,s.props||{})}),this.vm=this.app.mount(this.domRef.current)}componentDidUpdate(){if(!this.isUnmount){const{amisData:e}=this.resolveAmisProps();this.vm&&(Object.keys(e).forEach((t=>{this.vm[t]=e[t]})),this.vm.$forceUpdate())}}componentWillUnmount(){this.isUnmount=!0;this.context.unRegisterComponent(this),this.app.unmount()}resolveAmisProps(){let e={},t={};return Object.keys(this.props).forEach((o=>{const n=this.props[o];var a;"function"==typeof n?e[o]=n:r(n)?t[o]=s(n):(a=n,"Object"===Object.prototype.toString.call(a).slice(8,-1)?t[o]=i(n):t[o]=n)})),{amisData:t,amisFunc:e}}reload(){this.vm&&this.vm.reload?this.vm.reload():console.warn("自定义组件暂不支持reload动作。")}doAction(e,t){this.vm&&this.vm.doAction?this.vm.doAction(e,t):console.warn("自定义组件中不存在doAction。")}render(){return t.createElement("div",{ref:this.domRef})}}return c}}function h(e,t){if(!e)return;const o={type:"",usage:m.renderer,weight:0,framework:p.react};var n;if(t&&(n=t,"String"===Object.prototype.toString.call(n).slice(8,-1))?Object.assign(o,{type:t}):Object.assign(o,t),o&&!o.type)console.error(`${c}amis渲染器注册失败，渲染器类型（type）不能为空。`);else{o.framework=function(e){let t=p.react;if(!e)return t;let o=e.toLowerCase().trim();switch(o){case"jquery":case"jq":o=p.jquery;break;case"vue2":case"vue 2":case"vue2.0":case"vue 2.0":o=p.vue2,console.error("vue3-amis-widget不支持vue2.0技术栈，请改用amis-widget支持。");break;case"vue":case"vue3":case"vue 3":case"vue3.0":case"vue 3.0":o=p.vue3;break;default:o=p.react}return o}(o.framework),o.usage=function(e){let t=m.renderer;if(!e)return t;let o=e.toLowerCase().trim();switch(o){case"renderer":case"renderers":default:o=m.renderer;break;case"formitem":case"form-item":case"form item":o=m.formitem;break;case"options":case"option":case"formoption":case"form-option":case"form option":o=m.options}return o}(o.usage);const t={renderer:()=>{},formitem:()=>{},options:()=>{}},n={react:e=>e,vue2:l,vue3:l,jquery:f}[o.framework](e);if(t[o.usage]){if(window&&window.postMessage){const e=function(e,t){window&&!window.AmisCustomRenderers&&(window.AmisCustomRenderers={});if(!window.AmisCustomRenderers[e])return window.AmisCustomRenderers[e]=t,e;console.error(`${c}注册amis渲染器失败，已存在重名渲染器(${e})。`);return null}(o.type,{type:o.type,weight:o.weight,usage:o.usage,framework:o.framework,component:n,config:o});e&&(console.info(`${c}触发注册amis渲染器(${e})事件`),window.postMessage({type:"amis-renderer-register-event",eventMsg:`${c}注册一个自定义amis渲染器`,amisRenderer:{type:e,weight:o.weight,usage:o.usage,config:o}},"*"))}}else console.error(`${c}amis渲染器注册失败，暂不支持${o.usage}组件类型。`)}}!function(e){e.renderer="renderer",e.formitem="formitem",e.options="options"}(m||(m={})),function(e){e.react="react",e.vue2="vue2",e.vue3="vue3",e.jquery="jquery"}(p||(p={}));export{l as createVue3Component,u as registerAmisEditorPlugin,h as registerRendererByType};
